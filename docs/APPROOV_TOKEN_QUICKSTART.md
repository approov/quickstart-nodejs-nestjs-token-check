# Approov Token Quickstart

This quickstart is for developers familiar with NestJS who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. Therefore this will guide you through the necessary steps for adding Approov to an existing NestJS API server.

## TOC - Table of Contents

* [Why?](#why)
* [How it Works?](#how-it-works)
* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-check)
* [Test the Approov Integration](#test-your-approov-integration)

## Why?

To lock down your API server to your mobile app. Please read the brief summary in the [Approov Overview](/OVERVIEW.md#why) at the root of this repo or visit our [website](https://approov.io/product/) for more details.

[TOC](#toc---table-of-contents)


## How it works?

For more background, see the [Approov Overview](/OVERVIEW.md#how-it-works) at the root of this repo.

The main functionality for the Approov token check is in the [Approov Token Middleware](/src/approov-protected-server/token-check/src/middleware/approov-token.middleware.ts) file that you can take a look at to see how simple is the code for the check.

[TOC](#toc---table-of-contents)


## Requirements

To complete this quickstart you will need both the NodeJS and the Approov CLI tool installed.

* NodeJS - Follow the official installation instructions from [here](https://nodejs.org/en/download/)
* Approov CLI - Follow our [installation instructions](https://approov.io/docs/latest/approov-installation/#approov-tool) and read more about each command and its options in the [documentation reference](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the NestJS API server we need a small amount of configuration. First, Approov needs to know the API domain that will be protected. Second, the NestJS API server needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

### Configure API Domain

Approov needs to know the domain name of the API for which it will issue tokens.

Add it with:

```bash
approov api -add your.api.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning) setup, out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box issuing the Approov CLI command and the Approov servers.

### Approov Secret

Approov tokens are signed with a symmetric secret. To verify tokens, we need to grab the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the NodeJS API server environment to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.

Retrieve the Approov secret with:

```bash
approov secret -get base64
```

> **NOTE:** The `approov secret` command requires an [administration role](https://approov.io/docs/latest/approov-usage-documentation/#account-access-roles) to execute successfully.

#### Set the Approov Secret

Add the Approov secret to your environment:

```bash
export APPROOV_BASE64_SECRET=approov_base64_secret_here
```

[TOC](#toc---table-of-contents)


## Approov Token Check

To check the Approov token we will use this [JWT dependency](https://github.com/auth0/node-jsonwebtoken#readme), that may already exist on your project in case you have `@nestjs/jwt` listed on your `package.json` file. You are free to use another one of your preference, but you will need to adapt it to the provided code examples.

First, you need to add the `middleware/approov-token.middleware.ts` to your project:

```javascript
import { Injectable, NestMiddleware, UnauthorizedException } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { verify } from 'jsonwebtoken';

const approovBase64Secret = process.env.APPROOV_BASE64_SECRET

if (!approovBase64Secret) {
  throw new Error("The APPROOV_BASE64_SECRET env var is not set.")
}

const approovSecret = Buffer.from(approovBase64Secret, 'base64')

@Injectable()
export class ApproovTokenMiddleware implements NestMiddleware {

  use(req: Request, res: Response, next: NextFunction) {

    const approovToken = req.headers["approov-token"]

    if (!approovToken) {
      // You may want to add some logging here
      throw new UnauthorizedException('Unauthorized Access')
    }

    verify(`${approovToken}`, approovSecret, { algorithms: ['HS256'] }, function(err, decoded) {

      if (err) {
        // You may want to add some logging here
        throw new UnauthorizedException('Unauthorized Access')
      }

      console.debug("Approov token decoded: ", decoded)

      if (!decoded["exp"]) {
        // You may want to add some logging here
        throw new UnauthorizedException('Unauthorized Access')
      }

      // Adding the Approov token claims to the request object so that other
      // parts of the request life cycle can access it. For example, the Approov
      // token binding middleware.
      req["approovTokenClaims"] = decoded;
    });

    next();
  }
}
```

Finally, enable the use of the Approov token middleware on your App module:

```javascript
import { ApproovTokenMiddleware } from './middleware/approov-token.middleware';

export class AppModule {
  configure(consumer: MiddlewareConsumer) {
    // Ensure that the ApproovTokenMiddleware is always the first one to be
    // executed. For example, do not execute a rate limiter Middleware first.
    consumer.apply(ApproovTokenMiddleware).forRoutes('*')
  }
}
```

This enables the Approov token check for all your API endpoints. While its possible to enable Approov in a per endpoint basis we strongly recommend you to not do so, unless you have an application consuming the API endpoint that cannot be protected with the Approov SDK. Billing shouldn't be also a concern on the decision process for the number of API endpoints to be protected with Approov, because you are billed based on the number of monthly active devices, not on the the number of API requests made or API endpoints protected.

The *ApproovTokenMiddleware* should be the first one to be execute because it's establishing if you can trust in the incoming request as one coming from **what** your API backend expects, a genuine and unmodified version of your mobile app that is running in a trusted device, where a MitM attack is not being carried out. You don't want to waste your API server resources with processing API requests from untrustworthy sources, like bots and one of API requests made with tools like cURL, Postman and others.

A full working example for a simple Hello World server can be found at [src/approov-protected-server/token-check](/src/approov-protected-server/token-check).

[TOC](#toc---table-of-contents)


## Test your Approov Integration

The following examples below use cURL, but you can also use the [Postman Collection](/README.md#testing-with-postman) to make the API requests. Just remember that you need to adjust the urls and tokens defined in the collection to match your deployment. Alternatively, the above README also contains instructions for using the preset _dummy_ secret to test your Approov integration.

#### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```bash
approov token -genExample your.api.domain.com
```

Then make the request with the generated token:

```bash
curl -i --request GET 'https://your.api.domain.com' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The request should be accepted. For example:

```text
HTTP/2 200

...

{"message": "Hello, World!"}
```

#### With Invalid Approov Tokens

Generate an invalid token example from the Approov Cloud service:

```bash
approov token -type invalid -genExample your.api.domain.com
```

Then make the request with the generated token:

```bash
curl -i --request GET 'https://your.api.domain.com' \
  --header 'Approov-Token: APPROOV_INVALID_TOKEN_EXAMPLE_HERE'
```

The above request should fail with an Unauthorized error. For example:

```text
HTTP/2 401

...

{}
```

[TOC](#toc---table-of-contents)
